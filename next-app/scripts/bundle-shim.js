#!/usr/bin/env node
/**
 * Bundle separate Python shim files into a single browser-loadable file
 */

const fs = require('fs');
const path = require('path');

// Read the separate shim files
const coreShim = fs.readFileSync(
  path.join(__dirname, '../src/shims/pyspark/core.py'),
  'utf8'
);

const functionsShim = fs.readFileSync(
  path.join(__dirname, '../src/shims/pyspark/functions.py'),
  'utf8'
);

const windowShim = fs.readFileSync(
  path.join(__dirname, '../src/shims/pyspark/window.py'),
  'utf8'
);

// Remove module docstrings and imports that won't work in single file
const cleanCore = coreShim
  .replace(/"""[\s\S]*?"""\n\n/, '') // Remove module docstring
  .replace(/^import pandas as pd\n/m, '') // Will add at top
  .replace(/^from typing import.*\n/gm, ''); // Remove typing imports

const cleanFunctions = functionsShim
  .replace(/"""[\s\S]*?"""\n\n/, '')
  .replace(/^import pandas as pd\n/m, '')
  .replace(/^from \.core import Column\n/m, ''); // Remove relative import

const cleanWindow = windowShim
  .replace(/"""[\s\S]*?"""\n/g, '')
  .replace(/^from \.core import Column\n/m, ''); // Remove relative import

// Bundle everything together
const bundledShim = `# PySpark Shim - Complete bundled version
# Auto-generated by scripts/bundle-shim.js
import pandas as pd
import sys
from types import ModuleType

# ============ CORE CLASSES ============
${cleanCore}

# ============ FUNCTIONS ============
${cleanFunctions}

# ============ WINDOW FUNCTIONS ============
${cleanWindow}

# ============ MODULE SETUP ============
# Create proper module structure for imports
pyspark_module = ModuleType('pyspark')
pyspark_sql_module = ModuleType('pyspark.sql')
pyspark_sql_functions_module = ModuleType('pyspark.sql.functions')
pyspark_sql_window_module = ModuleType('pyspark.sql.window')

# Add classes to pyspark.sql
pyspark_sql_module.Row = Row
pyspark_sql_module.Column = Column
pyspark_sql_module.DataFrame = DataFrame
pyspark_sql_module.SparkSession = SparkSession
pyspark_sql_module.GroupedData = GroupedData

# Add all functions to pyspark.sql.functions
pyspark_sql_functions_module.col = col
pyspark_sql_functions_module.lit = lit
pyspark_sql_functions_module.avg = avg
pyspark_sql_functions_module.sum = sum
pyspark_sql_functions_module.count = count
pyspark_sql_functions_module.min = min
pyspark_sql_functions_module.max = max
pyspark_sql_functions_module.round = round
pyspark_sql_functions_module.upper = upper
pyspark_sql_functions_module.lower = lower
pyspark_sql_functions_module.initcap = initcap
pyspark_sql_functions_module.concat = concat
pyspark_sql_functions_module.concat_ws = concat_ws
pyspark_sql_functions_module.length = length
pyspark_sql_functions_module.substring = substring
pyspark_sql_functions_module.trim = trim
pyspark_sql_functions_module.ltrim = ltrim
pyspark_sql_functions_module.rtrim = rtrim
pyspark_sql_functions_module.lpad = lpad
pyspark_sql_functions_module.rpad = rpad
pyspark_sql_functions_module.when = when
pyspark_sql_functions_module.explode = explode
pyspark_sql_functions_module.split = split
pyspark_sql_functions_module.isnull = isnull
pyspark_sql_functions_module.isnan = isnan
pyspark_sql_functions_module.coalesce = coalesce
pyspark_sql_functions_module.row_number = row_number
pyspark_sql_functions_module.rank = rank
pyspark_sql_functions_module.dense_rank = dense_rank
pyspark_sql_functions_module.lag = lag
pyspark_sql_functions_module.lead = lead

# Add window to pyspark.sql.window
pyspark_sql_window_module.Window = Window
pyspark_sql_window_module.WindowSpec = WindowSpec

# Register modules in sys.modules
sys.modules['pyspark'] = pyspark_module
sys.modules['pyspark.sql'] = pyspark_sql_module
sys.modules['pyspark.sql.functions'] = pyspark_sql_functions_module
sys.modules['pyspark.sql.window'] = pyspark_sql_window_module

# Make spark available globally
spark = SparkSession()

print("✓ PySpark shim loaded (complete bundle)")
`;

// Write to public/shims
const outputPath = path.join(__dirname, '../public/shims/pyspark-shim.py');
fs.writeFileSync(outputPath, bundledShim);

console.log(`✓ Bundled shim written to ${outputPath}`);
console.log(`  Size: ${Math.round(bundledShim.length / 1024)}KB`);
